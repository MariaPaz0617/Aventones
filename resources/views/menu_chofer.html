<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Menú Chofer - Rides App</title>
  <link rel="stylesheet" href="../css/menu.css">
</head>
<body>

  <!-- Encabezado -->
  <header class="header">
    <div id="perfilChofer" class="perfil-chofer"></div>
    <button onclick="cerrarSesion()" class="btn-salir">Cerrar sesión</button>
  </header>

  <!-- Gestión de Vehículos -->
  <section class="seccion">
    <h2>Mis Vehículos</h2>
    <button class="btn-accion" onclick="abrirModal()">Registrar nuevo vehículo</button>


    <!-------------------------  MODALS PARA SECCIONES -------------------------------->
    <!-- Modal para registrar vehículo -->
    <div id="modalVehiculo" class="modal">
      <div class="modal-contenido">
        <span class="cerrar" onclick="cerrarModal()">&times;</span>
        <h3 id="tituloModalVehiculo">Registrar nuevo vehículo</h3>
        <form id="formVehiculo">
          <input type="text" name="placa" placeholder="Placa" required>
          <input type="text" name="color" placeholder="Color">
          <input type="text" name="marca" placeholder="Marca">
          <input type="text" name="modelo" placeholder="Modelo">
          <input type="number" name="año" placeholder="Año">
          <input type="number" name="capacidad_asientos" placeholder="Capacidad de asientos" min="1" required>
          <div id="campoFoto">
            <input type="file" name="foto" accept="image/*">
          </div>
          <button type="submit" id="botonModalVehiculo" class="btn-accion">Guardar vehículo</button>
        </form>
      </div>
    </div>


    <div id="listaVehiculos">
    </div>
  </section>

  <!-- Gestión de Rides -->
  <section class="seccion">
    <h2>Mis Rides</h2>
    <button class="btn-accion" onclick="mostrarPanelRide()">Crear nuevo ride</button>

    <!-- Panel embebido para crear/editar ride -->
    <div id="panelRide" class="panel-oculto">
      <span class="cerrar" onclick="ocultarPanelRide()">&times;</span>
      <h3 id="tituloModalRide">Crear nuevo ride</h3>
      <form id="formRide">
        <input type="text" name="nombre" placeholder="Nombre del ride" required>
        <input type="text" name="lugar_salida" placeholder="Lugar de salida" required>
        <input type="text" name="lugar_llegada" placeholder="Lugar de llegada" required>
        <input type="date" name="fecha" required>
        <input type="time" name="hora" required>
        <input type="number" name="costo" placeholder="Costo por espacio" min="0" step="0.01" required>
        <input type="number" name="cantidad_espacios" placeholder="Cantidad de espacios" min="1" required>

        <select name="vehiculo_id" required>
          <option value="">Seleccione un vehículo</option>
          <!-- Opciones dinámicas -->
        </select>

        <button type="submit" id="botonModalRide" class="btn-accion">Guardar ride</button>
      </form>
    </div>

    <div id="listaRides">
      <table id="tablaRides" class="tabla-rides">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Salida</th>
            <th>Llegada</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Costo</th>
            <th>Espacios</th>
            <th>Vehículo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Aquí se insertarán las filas dinámicamente -->
        </tbody>
      </table>
    </div>

    <p id="mensajeSinRides" class="sin-rides" style="display:none;">No tienes rides registrados aún.</p>
  </section>



  <!-- Reservas -->
  <section class="seccion">
    <h2>Solicitudes de Reserva</h2>
    <table id="tablaReservasChofer" class="tabla">
      <thead>
        <tr>
          <th>Pasajero</th>
          <th>Ruta</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Perfil -->
  <section class="seccion">
    <h2>Mi Perfil</h2>
    <div id="perfilChoferPerfil"></div>

    <button class="btn-accion" onclick="mostrarPanel('panelEditarDatos')">Editar datos</button>
    <button class="btn-accion" onclick="mostrarPanel('panelContrasena')">Cambiar contraseña</button>
    <button class="btn-accion" onclick="mostrarPanel('panelFoto')">Cambiar fotografía</button>

    <!-- Panel editar datos -->
    <div id="panelEditarDatos" class="panel-oculto">
      <span class="cerrar" onclick="ocultarPanel('panelEditarDatos')">&times;</span>
      <form id="formEditarChofer">
        <input type="text" name="nombre" placeholder="Nombre" required>
        <input type="text" name="apellido" placeholder="Apellido" required>
        <input type="email" name="email" placeholder="Correo electrónico" required>
        <input type="text" name="telefono" placeholder="Teléfono" required>
        <button type="submit" class="btn-accion">Actualizar datos</button>
      </form>
    </div>

    <!-- Panel cambiar contraseña -->
    <div id="panelContrasena" class="panel-oculto">
      <span class="cerrar" onclick="ocultarPanel('panelContrasena')">&times;</span>
      <form id="formContrasena">
        <input type="password" name="actual" placeholder="Contraseña actual" required>
        <input type="password" name="nueva" placeholder="Nueva contraseña" required>
        <input type="password" name="confirmar" placeholder="Confirmar nueva contraseña" required>
        <button type="submit" class="btn-accion">Actualizar contraseña</button>
      </form>
    </div>

    <!-- Panel cambiar fotografía -->
    <div id="panelFoto" class="panel-oculto">
      <span class="cerrar" onclick="ocultarPanel('panelFoto')">&times;</span>
      <form id="formFotoChofer">
        <input type="file" name="foto" accept="image/*" required onchange="vistaPreviaFotoChofer(event)">
        <img id="previewFotoChofer" src="" alt="Vista previa" style="max-width: 150px; margin-top: 10px; display: none;">
        <button type="submit" class="btn-accion">Actualizar fotografía</button>
      </form>
    </div>
  </section>
  <!-- Pie de página -->
  <footer class="footer">
    <p>&copy; 2025 Aventones. Maria Paz Ugalde - Xavier Fernández.</p>
  </footer>



  <!-- Script para mostrar datos del chofer y demas funcionalidads -->
  <script>
    const usuario = JSON.parse(localStorage.getItem("usuario"));

    if (!usuario || usuario.rol !== "chofer") {
      window.location.href = "login.html";
    } else {
      const perfilDiv = document.getElementById("perfilChofer");
      perfilDiv.innerHTML = `
        <h3>Bienvenido, ${usuario.nombre} ${usuario.apellido}</h3>
        <img src="../img/${usuario.foto}" alt="Foto de perfil" style="width:50px; border-radius:50%;">
        <p>${usuario.email}</p>
      `;
    }

    function cerrarSesion() {
      localStorage.removeItem("usuario");
      window.location.href = "menu_rides.html";
    }

    function abrirModal() {
      const form = document.getElementById("formVehiculo");

      form.reset();
      delete form.dataset.editar;
      delete form.dataset.fotoActual;
      delete form.dataset.colorOriginal;

      document.getElementById("tituloModalVehiculo").textContent = "Registrar nuevo vehículo";
      document.getElementById("botonModalVehiculo").textContent = "Guardar vehículo";

      const campoFoto = document.getElementById("campoFoto");
      const inputFoto = campoFoto.querySelector("input[name='foto']");
      campoFoto.style.display = "block";
      inputFoto.disabled = false;
      inputFoto.required = true;

      document.getElementById("modalVehiculo").style.display = "block";
    }

    function cerrarModal() {
      const form = document.getElementById("formVehiculo");
      form.reset();
      delete form.dataset.editar;
      delete form.dataset.fotoActual;
      delete form.dataset.colorOriginal;

      // Restaurar título y botón
      document.getElementById("tituloModalVehiculo").textContent = "Registrar nuevo vehículo";
      document.getElementById("botonModalVehiculo").textContent = "Guardar vehículo";

      // Ocultar campo de imagen
      document.getElementById("campoFoto").style.display = "block";

      document.getElementById("modalVehiculo").style.display = "none";
    }

    window.onclick = function(event) {
      const modal = document.getElementById("modalVehiculo");
      if (event.target === modal) {
        cerrarModal();
      }
    }

    // Manejo del formulario de registro de vehículo
    document.getElementById("formVehiculo").addEventListener("submit", async function(e) {
      e.preventDefault();

      const usuario = JSON.parse(localStorage.getItem("usuario"));
      const form = document.getElementById("formVehiculo");
      const formData = new FormData(form);

      const idEditar = form.dataset.editar;
      const fotoActual = form.dataset.fotoActual;
      const colorOriginal = form.dataset.colorOriginal;
      const colorActual = form.color.value.trim();
      const nuevaFoto = form.foto.files[0];

      if (idEditar) {
        // Modo edición
        const colorModificado = colorOriginal !== colorActual;

        if (colorModificado && !nuevaFoto) {
          alert("Debes subir una nueva imagen si modificas el color del vehículo.");
          return;
        }

        formData.append("id", idEditar);
        formData.append("foto_actual", fotoActual);
        formData.append("color_modificado", colorModificado ? "1" : "0");

        const response = await fetch("../php/editar_vehiculo.php", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        alert(data.message);

        if (data.success) {
          cerrarModal();
          form.reset();
          delete form.dataset.editar;
          delete form.dataset.fotoActual;
          delete form.dataset.colorOriginal;
          cargarVehiculos();
        }
      } else {
        //Modo registro
        formData.append("usuario_id", usuario.id);

        const response = await fetch("../php/registrar_vehiculo.php", {
          method: "POST",
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          alert(data.message);
          cerrarModal();
          form.reset();
          cargarVehiculos(); //Recargar la lista de vehículos
        } else {
          alert(data.message);
        }
      }
    });

    //Cargar vehículos al iniciar
    async function cargarVehiculos() {
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      const contenedor = document.getElementById("listaVehiculos");

      const response = await fetch("../php/obtener_vehiculos.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario_id: usuario.id })
      });

      const data = await response.json();
      contenedor.innerHTML = ""; //Limpia el contenedor

      if (data.success && data.vehiculos.length > 0) {
        data.vehiculos.forEach(v => {
          const tarjeta = document.createElement("div");
          tarjeta.className = "vehiculo-card";
          tarjeta.innerHTML = `
            <img src="../img/${v.foto}" alt="Foto del vehículo">
            <div class="vehiculo-info">
              <p><strong>Placa:</strong> ${v.placa}</p>
              <p><strong>Marca:</strong> ${v.marca}</p>
              <p><strong>Modelo:</strong> ${v.modelo}</p>
              <p><strong>Año:</strong> ${v.año}</p>
              <p><strong>Color:</strong> ${v.color}</p>
              <p><strong>Capacidad:</strong> ${v.capacidad_asientos} asientos</p>
            </div>
            <div class="vehiculo-acciones">
              <button class="btn-editar" onclick='prepararEdicion(${JSON.stringify(v)})'>Editar</button>
              <button class="btn-eliminar" onclick="eliminarVehiculo(${v.id})">Eliminar</button>
            </div>
          `;
          contenedor.appendChild(tarjeta);
        });
      } else {
        contenedor.innerHTML = `<p class="sin-vehiculos">No tienes vehículos registrados aún.</p>`;
      }
    }

    cargarVehiculos();

    //Eliminar vehículo
    async function eliminarVehiculo(id) {
      if (!confirm("¿Estás seguro de que deseas eliminar este vehículo?")) return;

      const response = await fetch("../php/eliminar_vehiculo.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });

      const data = await response.json();
      alert(data.message);
      if (data.success) cargarVehiculos();
    }


    function prepararEdicion(v) {
      abrirModal();

      const form = document.getElementById("formVehiculo");
      form.placa.value = v.placa;
      form.color.value = v.color;
      form.marca.value = v.marca;
      form.modelo.value = v.modelo;
      form.año.value = v.año;
      form.capacidad_asientos.value = v.capacidad_asientos;

      form.dataset.editar = v.id;
      form.dataset.fotoActual = v.foto;
      form.dataset.colorOriginal = v.color;

      //Cambiar título y botón
      document.getElementById("tituloModalVehiculo").textContent = "Editar vehículo";
      document.getElementById("botonModalVehiculo").textContent = "Actualizar vehículo";

      //Mostrar y habilitar campo de imagen
      const campoFoto = document.getElementById("campoFoto");
      const inputFoto = campoFoto.querySelector("input[name='foto']");
      campoFoto.style.display = "block";
      inputFoto.disabled = false;
      inputFoto.required = false;

      //Si el color cambia, exigir imagen
      form.color.addEventListener("input", function () {
        const colorModificado = form.color.value.trim() !== form.dataset.colorOriginal;
        inputFoto.required = colorModificado;
      });
    }






    //---------------------FUNCIONALIDAD RIDES---------------------//
    async function cargarRides() {
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      const tablaBody = document.querySelector("#tablaRides tbody");
      const mensaje = document.getElementById("mensajeSinRides");

      const response = await fetch("../php/obtener_rides.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario_id: usuario.id })
      });

      const data = await response.json();
      tablaBody.innerHTML = ""; // Limpia la tabla

      if (data.success && data.rides.length > 0) {
        mensaje.style.display = "none";

        data.rides.forEach(r => {
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${r.nombre}</td>
            <td>${r.lugar_salida}</td>
            <td>${r.lugar_llegada}</td>
            <td>${r.fecha}</td>
            <td>${r.hora}</td>
            <td>₡${parseFloat(r.costo).toFixed(2)}</td>
            <td>${r.cantidad_espacios}</td>
            <td>${r.vehiculo_marca} ${r.vehiculo_modelo} (${r.vehiculo_año})</td>
            <td>
              <button class="btn-editar" onclick='prepararEdicionRide(${JSON.stringify(r)})'>Editar</button>
              <button class="btn-eliminar" onclick="eliminarRide(${r.id})">Eliminar</button>
            </td>
          `;
          tablaBody.appendChild(fila);
        });
      } else {
        mensaje.style.display = "block";
      }
    }

    //Abrir modal ride
    function mostrarPanelRide() {
      const form = document.getElementById("formRide");
      form.reset();
      delete form.dataset.editar;

      document.getElementById("tituloModalRide").textContent = "Crear nuevo ride";
      document.getElementById("botonModalRide").textContent = "Guardar ride";

      cargarVehiculosEnSelect();

      document.getElementById("panelRide").className = "panel-visible";
    }

    function ocultarPanelRide() {
      document.getElementById("panelRide").className = "panel-oculto";
    }

    //Cargar vehículos en el select del formulario de ride
    function cargarVehiculosEnSelect() {
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      const select = document.querySelector("#formRide select[name='vehiculo_id']");

      return fetch("../php/obtener_vehiculos.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario_id: usuario.id })
      })
      .then(response => response.json())
      .then(data => {
        select.innerHTML = `<option value="">Seleccione un vehículo</option>`;
        if (data.success && data.vehiculos.length > 0) {
          data.vehiculos.forEach(v => {
            const option = document.createElement("option");
            option.value = v.id;
            option.textContent = `${v.marca} ${v.modelo} (${v.año})`;
            select.appendChild(option);
          });
        }
      });
    }

    // Manejo del formulario de creación/edición de ride
    document.getElementById("formRide").addEventListener("submit", async function(e) {
      e.preventDefault();

      const form = document.getElementById("formRide");
      const formData = new FormData(form);
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      formData.append("usuario_id", usuario.id);

      const idEditar = form.dataset.editar;
      const endpoint = idEditar ? "../php/editar_ride.php" : "../php/registrar_ride.php";

      if (idEditar) formData.append("id", idEditar);

      const response = await fetch(endpoint, {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      alert(data.message);

      if (data.success) {
        ocultarPanelRide();
        form.reset();
        delete form.dataset.editar;
        cargarRides();
      }
    });

    //Preparar edición de ride
    function prepararEdicionRide(r) {
      const form = document.getElementById("formRide");

      // Mostrar el panel embebido
      document.getElementById("panelRide").className = "panel-visible";

      // Resetear y precargar datos
      form.reset();
      form.nombre.value = r.nombre;
      form.lugar_salida.value = r.lugar_salida;
      form.lugar_llegada.value = r.lugar_llegada;
      form.fecha.value = r.fecha;
      form.hora.value = r.hora;
      form.costo.value = r.costo;
      form.cantidad_espacios.value = r.cantidad_espacios;

      form.dataset.editar = r.id;

      // Cargar vehículos y seleccionar el correcto
      cargarVehiculosEnSelect().then(() => {
        form.vehiculo_id.value = r.vehiculo_id;
      });

      // Actualizar encabezado y botón
      document.getElementById("tituloModalRide").textContent = "Editar ride";
      document.getElementById("botonModalRide").textContent = "Actualizar ride";
      cargarRides();
    }

    //Eliminar ride
    async function eliminarRide(id) {
      if (!confirm("¿Estás seguro de que deseas eliminar este ride?")) return;

      const response = await fetch("../php/eliminar_ride.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });

      const data = await response.json();
      alert(data.message);

      if (data.success) {
        cargarRides(); // ✅ refresca solo el cuadro
      }
    }


    //---------------------FUNCIONALIDAD RESERVAS DEL CHOFER---------------------//
    async function cargarReservasChofer() {
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      const response = await fetch("../php/obtener_reservas_chofer.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chofer_id: usuario.id })
      });

      const data = await response.json();
      const tbody = document.querySelector("#tablaReservasChofer tbody");

      if (data.success && data.reservas.length > 0) {
        tbody.innerHTML = "";
        data.reservas.forEach(r => {
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${r.pasajero_nombre}</td>
            <td>${r.lugar_salida} → ${r.lugar_llegada}</td>
            <td>${r.fecha}</td>
            <td>${r.hora}</td>
            <td>${r.estado}</td>
            <td>
              ${r.estado.trim().toLowerCase() === "pendiente"
                ? `<button onclick="aceptarReserva(${r.reserva_id})">Aceptar</button>
                  <button onclick="rechazarReserva(${r.reserva_id})">Rechazar</button>`
                : "<em>Sin acciones</em>"}
            </td>
          `;
          tbody.appendChild(fila);
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="6"><em>No hay solicitudes de reserva.</em></td></tr>`;
      }
    }

    async function aceptarReserva(id) {
      const response = await fetch("../php/actualizar_estado_reserva.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, estado: "aceptada" })
      });

      const data = await response.json();
      alert(data.message);
      if (data.success) cargarReservasChofer();
    }

    async function rechazarReserva(id) {
      const response = await fetch("../php/actualizar_estado_reserva.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, estado: "rechazada" })
      });

      const data = await response.json();
      alert(data.message);
      if (data.success) cargarReservasChofer();
    }



    //---------------------FUNCIONALIDAD MODALS PARA EDITAR CHOFER---------------------//

    // Ocultar todos los paneles al cargar la página
    // Ocultar todos los paneles al cargar (inline + clase)
    document.addEventListener('DOMContentLoaded', () => {
      ['panelEditarDatos', 'panelContrasena', 'panelFoto'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = 'none';                  // <-- fuerza inline
        el.classList.remove('panel-visible');
        el.classList.add('panel-oculto');
      });
    });

    // Mostrar el panel solicitado
    function mostrarPanel(id) {
      const paneles = ['panelEditarDatos', 'panelContrasena', 'panelFoto'];

      // Oculta todos (inline + clase)
      paneles.forEach(p => {
        const panel = document.getElementById(p);
        if (!panel) return;
        panel.style.display = 'none';               // <-- fuerza inline
        panel.classList.remove('panel-visible');
        panel.classList.add('panel-oculto');
      });

      // Muestra el solicitado (inline + clase)
      const activo = document.getElementById(id);
      if (activo) {
        activo.style.display = 'block';             // <-- fuerza inline
        activo.classList.remove('panel-oculto');
        activo.classList.add('panel-visible');

        // Precarga/Reset según panel
        if (id === 'panelEditarDatos') {
          const form = document.getElementById('formEditarChofer');
          const usuario = JSON.parse(localStorage.getItem('usuario')) || {};
          form.nombre.value   = usuario.nombre   || '';
          form.apellido.value = usuario.apellido || '';
          form.email.value    = usuario.email    || '';
          form.telefono.value = usuario.telefono || '';
        }
        if (id === 'panelFoto') {
          document.getElementById('formFotoChofer').reset();
          document.getElementById('previewFotoChofer').style.display = 'none';
        }
        if (id === 'panelContrasena') {
          document.getElementById('formContrasena').reset();
        }
      }
    }

    // Ocultar el panel solicitado
    function ocultarPanel(id) {
      const panel = document.getElementById(id);
      if (!panel) return;
      panel.style.display = 'none';                 // <-- fuerza inline
      panel.classList.remove('panel-visible');
      panel.classList.add('panel-oculto');
    }


    // Manejo del formulario de edición de chofer
    document.getElementById("formEditarChofer").addEventListener("submit", async function(e) {
      e.preventDefault();

      const form = document.getElementById("formEditarChofer");
      const formData = new FormData(form);
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      formData.append("id", usuario.id);

      const response = await fetch("../php/editar_chofer.php", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      alert(data.message);

      if (data.success) {
        // Actualiza localStorage y perfil visual
        usuario.nombre = form.nombre.value;
        usuario.apellido = form.apellido.value;
        usuario.email = form.email.value;
        usuario.telefono = form.telefono.value;
        localStorage.setItem("usuario", JSON.stringify(usuario));
        ocultarPanel('panelEditarDatos');
        location.reload(); // O actualiza solo el perfil si prefieres
      }
    });

    //---------------------FUNCIONALIDAD MODALS PARA CAMBIAR CONTRASEÑA---------------------//
 
    // Manejo del formulario de cambio de contraseña
    document.getElementById("formContrasena").addEventListener("submit", async function(e) {
      e.preventDefault();

      const form = document.getElementById("formContrasena");
      const actual = form.actual.value.trim();
      const nueva = form.nueva.value.trim();
      const confirmar = form.confirmar.value.trim();
      const usuario = JSON.parse(localStorage.getItem("usuario"));

      if (nueva !== confirmar) {
        alert("La nueva contraseña y su confirmación no coinciden.");
        return;
      }

      const formData = new FormData();
      formData.append("id", usuario.id);
      formData.append("actual", actual);
      formData.append("nueva", nueva);

      const response = await fetch("../php/cambiar_contrasena.php", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      alert(data.message);

      if (data.success) {
        localStorage.removeItem("usuario");
        window.location.href = "login.html";
        return;
      }
    });

    //---------------------FUNCIONALIDAD MODALS PARA CAMBIAR IMAGEN PERFIL---------------------//

    function vistaPreviaFotoChofer(event) {
      const file = event.target.files[0];
      const preview = document.getElementById("previewFotoChofer");

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
    }

    // Manejo del formulario de cambio de foto de perfil
    document.getElementById("formFotoChofer").addEventListener("submit", async function(e) {
      e.preventDefault();

      const form = document.getElementById("formFotoChofer");
      const formData = new FormData(form);
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      formData.append("id", usuario.id);

      const response = await fetch("../php/cambiar_foto_chofer.php", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      alert(data.message);

      if (data.success && data.foto) {
        usuario.foto = data.foto;
        localStorage.setItem("usuario", JSON.stringify(usuario));
        ocultarPanel('panelFoto');
        location.reload(); // O actualiza solo el perfil visual
      }
    });

    cargarRides();
    cargarReservasChofer();
  </script>
</body>
</html>